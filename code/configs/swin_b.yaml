experiment:
  name: swin_b_baseline+prompt
  seed: 42
  output_dir: outputs
  save_checkpoints: false
  checkpoint_freq: 10

data:
  root_path: "/proj/berzbiomedicalimagingkth/users/x_hujun/Foundation-Model-Challenge-for-Ultrasound-Image-Analysis/dataset/"
  val_split: 0.2
  batch_size: 64
  num_workers: 4
  pin_memory: true
  image_size: 224
  augmentation:
    train:
      random_brightness_contrast: 0.2
      gauss_noise: 0.1
      horizontal_flip: 0.0
      vertical_flip: 0.0
    normalize:
      mean: [0.485, 0.456, 0.406]
      std: [0.229, 0.224, 0.225]

model:
  moe:
    enabled: false
    num_experts: 8
    top_k: 1
    stage_indices: [3, 4]
    expert_hidden: 256
    router_hidden: 256
    balance_loss_weight: 0.05
    use_task_embedding: true
    task_embedding_dim: 64
    use_residual: true
    dropout: 0.0

  encoder:
    name: swin_b
    pretrained: imagenet
    freeze_encoder: false

  decoder:
    type: fpn
    pyramid_channels: 256
    segmentation_channels: 128
    dropout: 0.2
    merge_policy: cat
    separate_detection_fpn: true
    separate_classification_fpn: true
    separate_regression_fpn: true
    use_fpn_for_classification: false
    use_fpn_for_regression: false

  use_film: false
  film:
    use_task_embedding: false
    embedding_dim: 64
    use_affine: true

  heads:
    segmentation:
      type: baseline
      upsampling: 4
      mid_channels: 128
      num_blocks: 2
      use_deep_supervision: false
      num_aux_outputs: 3
      aux_loss_weights: [0.5, 0.3, 0.2]

    classification:
      type: baseline
      mid_channels: 256
      dropout: 0.3

    detection:
      type: baseline
      mid_channels: 128
      num_anchors: 1

    regression:
      type: baseline
      hidden_dims: [256, 128]
      use_tanh: true
      mid_channels: 256
      dropout: 0.3

training:
  num_epochs: 50

  single_task:
    enabled: false
    task_id: ""
    task_name: Detection

  optimizer:
    type: AdamW
    learning_rate: 0.0001
    weight_decay: 0.0001
    use_grouped_lr: true
    encoder_lr_multiplier: 0.1
    head_lr_multiplier: 1.0

  scheduler:
    type: CosineAnnealingLR
    T_max: 50
    eta_min: 1e-6

  loss_weights:
    segmentation: 1.0
    classification: 1.0
    detection: 1.0
    regression: 1.0

  adaptive_loss:
    enabled: false
    init_log_vars: -1.0
    learning_rate: 0.0001
    warmup_epochs: 3

  loss_configs:
    segmentation:
      type: DiceLoss
      mode: multiclass

    classification:
      type: CrossEntropyLoss

    detection:
      type: CenterNet
      heatmap_alpha: 2.0
      heatmap_gamma: 4.0
      size_weight: 1.0
      offset_weight: 1.0
      classification_weight: 2.0
      box_regression_weight: 1.0

    regression:
      type: MSELoss

  gradient_clip: 1.0
  accumulation_steps: 1
  print_freq: 50
  log_metrics: true

validation:
  enabled: true
  freq: 1
  save_best_model: true
  metric_for_best: mean_score

device:
  use_cuda: true
  multi_gpu: false
  device_ids: [0]
  mixed_precision: false

tasks:
  - task_id: T2A_fetal_abdomen
    task_name: segmentation
    num_classes: 2

  - task_id: T2A_fetal_brain
    task_name: segmentation
    num_classes: 2

  - task_id: T2A_fetal_femur
    task_name: segmentation
    num_classes: 2

  - task_id: T2A_fetal_thorax
    task_name: segmentation
    num_classes: 2

  - task_id: T2B_adult_liver_segment_2
    task_name: segmentation
    num_classes: 2

  - task_id: T2B_adult_liver_segment_3
    task_name: segmentation
    num_classes: 2

  - task_id: T2B_adult_liver_segment_4a
    task_name: segmentation
    num_classes: 2

  - task_id: T2B_adult_liver_segment_5
    task_name: segmentation
    num_classes: 2

  - task_id: T2B_adult_liver_segment_6
    task_name: segmentation
    num_classes: 2

  - task_id: T2B_adult_liver_segment_7
    task_name: segmentation
    num_classes: 2

  - task_id: T2B_adult_liver_segment_8
    task_name: segmentation
    num_classes: 2

  - task_id: T2C_fetal_head
    task_name: segmentation
    num_classes: 2

  - task_id: T1_fetal_planes
    task_name: classification
    num_classes: 6

  - task_id: T3A_breast_lymph_nodes
    task_name: classification
    num_classes: 2

  - task_id: T3A_breast_tumor
    task_name: classification
    num_classes: 2

  - task_id: T3B_liver_injury
    task_name: classification
    num_classes: 2

  - task_id: T3B_liver_steatosis
    task_name: classification
    num_classes: 2

  - task_id: T3C_thyroid_nodule
    task_name: classification
    num_classes: 2

  - task_id: T3D_liver_cirrhosis
    task_name: classification
    num_classes: 2

  - task_id: T3D_liver_fibrosis
    task_name: classification
    num_classes: 2

  - task_id: T3E_thyroid_cancer
    task_name: classification
    num_classes: 2

  - task_id: T4A_fetal_abdomen
    task_name: detection
    num_classes: 1

  - task_id: T4A_fetal_brain
    task_name: detection
    num_classes: 1

  - task_id: T4A_fetal_femur
    task_name: detection
    num_classes: 1

  - task_id: T5_fetal_abdomen
    task_name: Regression
    num_classes: 4

  - task_id: T5_fetal_brain
    task_name: Regression
    num_classes: 4

  - task_id: T5_fetal_femur
    task_name: Regression
    num_classes: 4